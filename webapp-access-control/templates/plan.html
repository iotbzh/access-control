{% extends 'base.html' %}

{% block content %}
<div class="container py-4">
    <h1 class="mb-4 text-center">
        <i class="bi bi-map me-2"></i>
        Plan du bâtiment
    </h1>
    <div class="text-center mb-3">
        <button id="edit-mode-btn" class="btn btn-warning">
            <i class="bi bi-pencil"></i> Mode édition
        </button>
        <button id="save-positions-btn" class="btn btn-success d-none">
            <i class="bi bi-save"></i> Enregistrer les positions
        </button>
    </div>
    <div id="svg-container" class="mx-auto" style="max-width:1000px; min-height:500px; border:2px solid #e3e3e3; border-radius:8px; background:#f8f9fa; display:flex; justify-content:center; align-items:center;">
        <svg id="plan-svg" width="1000" height="600" style="width:100%; height:600px;">
            <image href="{{ url_for('static', filename='plan.svg') }}" width="1000" height="600"/>
            {% for lecteur in lecteurs %}
                {% set status = lecteurs_status.get(lecteur[1], 'offline') %}
                <circle class="lecteur"
                        data-id="{{ lecteur[0] }}"
                        data-name="{{ lecteur[1] }}"
                        data-status="{{ status }}"
                        cx="{{ lecteur[2] }}"
                        cy="{{ lecteur[3] }}"
                        r="18"
                        fill="{% if status == 'online' %}#28a745{% elif status == 'alert' %}#ffc107{% else %}#dc3545{% endif %}"
                        stroke="#333"
                        stroke-width="2"
                        style="cursor: pointer;"
                />
                <text x="{{ lecteur[2] }}" y="{{ lecteur[3]|int + 35 }}" text-anchor="middle" font-size="14" fill="#333">
                    {{ lecteur[1] }}
                </text>
            {% endfor %}
        </svg>
    </div>
</div>

<!-- Bootstrap JS & Popper.js requis pour les tooltips -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Socket.IO -->
<script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.5/dist/socket.io.min.js"></script>
<script>
    // Fonction utilitaire pour la couleur
    function getStatusColor(status) {
        if (status === 'online') return '#28a745';
        if (status === 'alert') return '#ffc107';
        return '#dc3545';
    }

    // Initialisation des tooltips Bootstrap sur les cercles SVG
    function initTooltips() {
        const svg = document.getElementById('plan-svg');
        const circles = svg.querySelectorAll('.lecteur');
        circles.forEach(circle => {
            // Bootstrap Tooltip ne s'applique pas directement sur les SVG <circle>,
            // donc on utilise Tooltip "manuellement" avec un événement mouseover
            circle.addEventListener('mouseenter', function(e) {
                // Supprime tout tooltip existant
                let oldTooltip = document.getElementById('svg-tooltip');
                if (oldTooltip) oldTooltip.remove();

                // Crée le tooltip
                const tooltip = document.createElement('div');
                tooltip.id = 'svg-tooltip';
                tooltip.className = 'tooltip bs-tooltip-top show';
                tooltip.style.position = 'fixed';
                tooltip.style.pointerEvents = 'none';
                tooltip.style.zIndex = 1000;

                // Contenu
                const name = circle.getAttribute('data-name');
                const status = circle.getAttribute('data-status');
                tooltip.innerHTML = `<div class="tooltip-arrow"></div>
                    <div class="tooltip-inner">
                        <strong>${name}</strong><br>
                        Statut : <span class="badge bg-${status === 'online' ? 'success' : status === 'alert' ? 'warning' : 'danger'}">${status}</span>
                    </div>`;

                document.body.appendChild(tooltip);

                // Positionnement
                const rect = circle.getBoundingClientRect();
                tooltip.style.left = (rect.left + rect.width/2 - tooltip.offsetWidth/2) + 'px';
                tooltip.style.top = (rect.top - tooltip.offsetHeight - 8) + 'px';
            });
            circle.addEventListener('mouseleave', function(e) {
                let oldTooltip = document.getElementById('svg-tooltip');
                if (oldTooltip) oldTooltip.remove();
            });
        });
    }

    // Re-initialise les tooltips à chaque update
    function updateCirclesStatus(statuses) {
        for (const [name, status] of Object.entries(statuses)) {
            const circle = document.querySelector(`.lecteur[data-name="${name}"]`);
            if (circle) {
                circle.setAttribute('fill', getStatusColor(status));
                circle.setAttribute('data-status', status);
            }
        }
        initTooltips();
    }

    // Socket.IO
    const socket = io();
    socket.on('all_status', updateCirclesStatus);
    socket.on('status_update', updateCirclesStatus);

    // Initialisation au chargement
    document.addEventListener('DOMContentLoaded', function() {
        initTooltips();
    });
</script>
<script>
let isEditMode = false;
let dragTarget = null;
let offset = {x:0, y:0};
let startCoords = {x:0, y:0};
let moved = false;

document.getElementById('edit-mode-btn').addEventListener('click', function() {
    isEditMode = !isEditMode;
    this.classList.toggle('btn-warning', !isEditMode);
    this.classList.toggle('btn-secondary', isEditMode);
    this.innerHTML = isEditMode ? '<i class="bi bi-x"></i> Quitter édition' : '<i class="bi bi-pencil"></i> Mode édition';
    document.getElementById('save-positions-btn').classList.toggle('d-none', !isEditMode);

    // Change le curseur des lecteurs
    document.querySelectorAll('.lecteur').forEach(c => {
        c.style.cursor = isEditMode ? 'move' : 'pointer';
    });
});

// Drag & drop listeners
document.getElementById('plan-svg').addEventListener('mousedown', function(e) {
    if (!isEditMode) return;
    if (e.target.classList.contains('lecteur')) {
        dragTarget = e.target;
        startCoords = {
            x: parseFloat(dragTarget.getAttribute('cx')),
            y: parseFloat(dragTarget.getAttribute('cy'))
        };
        offset = {
            x: e.offsetX - startCoords.x,
            y: e.offsetY - startCoords.y
        };
        moved = false;
    }
});

document.getElementById('plan-svg').addEventListener('mousemove', function(e) {
    if (!isEditMode || !dragTarget) return;
    let svgRect = this.getBoundingClientRect();
    let x = e.clientX - svgRect.left - offset.x;
    let y = e.clientY - svgRect.top - offset.y;
    dragTarget.setAttribute('cx', x);
    dragTarget.setAttribute('cy', y);
    // Déplace aussi le texte associé
    let text = this.querySelector(`text[x="${startCoords.x}"][y="${startCoords.y+35}"]`);
    if (text) {
        text.setAttribute('x', x);
        text.setAttribute('y', y + 35);
    }
    moved = true;
});

document.getElementById('plan-svg').addEventListener('mouseup', function(e) {
    if (!isEditMode || !dragTarget) return;
    dragTarget = null;
});

document.getElementById('save-positions-btn').addEventListener('click', async function() {
    // Récupère les positions des lecteurs
    const svg = document.getElementById('plan-svg');
    const lecteurs = svg.querySelectorAll('.lecteur');
    let data = [];
    lecteurs.forEach(c => {
        data.push({
            id: c.getAttribute('data-id'),
            x: Math.round(parseFloat(c.getAttribute('cx'))),
            y: Math.round(parseFloat(c.getAttribute('cy')))
        });
    });
    // Envoie en AJAX
    const resp = await fetch('{{ url_for("update_lecteur_positions") }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });
    if (resp.ok) {
        alert('Positions enregistrées !');
        isEditMode = false;
        document.getElementById('edit-mode-btn').classList.remove('btn-secondary');
        document.getElementById('edit-mode-btn').classList.add('btn-warning');
        document.getElementById('edit-mode-btn').innerHTML = '<i class="bi bi-pencil"></i> Mode édition';
        document.getElementById('save-positions-btn').classList.add('d-none');
        document.querySelectorAll('.lecteur').forEach(c => c.style.cursor = 'pointer');
    } else {
        alert('Erreur lors de la sauvegarde !');
    }
});
</script>
<script>
    // Ouvrir la porte au clic (hors mode édition)
    document.getElementById('plan-svg').addEventListener('click', function (e) {
        if (isEditMode) return;
        if (e.target.classList.contains('lecteur')) {
            const lecteurName = e.target.getAttribute('data-name');
            if (confirm('Ouvrir la porte ' + lecteurName + ' ?')) {
                fetch(`/zones/${lecteurName}/open`, { method: 'POST' })
                    .then(resp => {
                        if (resp.ok) {
                            alert('Porte ouverte !');
                        } else {
                            alert('Erreur lors de l\'ouverture');
                        }
                    });
            }
        }
    });
    // Afficher l'historique d'accès au clic droit
    document.getElementById('plan-svg').addEventListener('contextmenu', function (e) {
        if (e.target.classList.contains('lecteur')) {
            e.preventDefault();
            const lecteurName = e.target.getAttribute('data-name');
            fetch(`/historique/${lecteurName}`)
                .then(resp => resp.text())
                .then(html => {
                    document.getElementById('historique-content').innerHTML = html;
                    new bootstrap.Modal(document.getElementById('historiqueModal')).show();
                });
        }
    });
</script>
<!-- Modale Bootstrap pour l'historique -->
<div class="modal fade" id="historiqueModal" tabindex="-1" aria-labelledby="historiqueModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="historiqueModalLabel">Historique d’accès</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body" id="historique-content">
        Chargement...
      </div>
    </div>
  </div>
</div>
{% endblock %}
