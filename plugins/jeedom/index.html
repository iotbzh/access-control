{% extends 'base.html' %}

{% block content %}

<div class="row">
  <div class="col-sm-4 text-center" id="fd-status">
    <div class="card">
      <div class="card-body p-5">
        <h5 class="card-title">Front Door</h5>
        <button disabled class="btn btn-success">...</a>
      </div>
    </div>
  </div>
  <div class="col-sm-4 text-center" id="bd-status">
    <div class="card">
      <div class="card-body p-5">
        <h5 class="card-title">Bike Door</h5>
        <button disabled class="btn btn-success">...</a>
      </div>
    </div>
  </div>
  <div class="col-sm-4 text-center" id="ld-status">
    <div class="card">
      <div class="card-body p-5">
        <h5 class="card-title">Lab Door</h5>
        <button disabled class="btn btn-success">...</a>
      </div>
    </div>
  </div>
</div>
<div class="row mt-4">
  <div class="col-sm-4 text-center" id="shutters-status">
    <div class="card">
      <div class="card-body p-5">
        <h5 class="card-title">Shutters (...)</h5>
        <button class="btn btn-primary" onclick="toggleShutters()">...</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
<script>
    var socket = io();
    var updatingShutters = false;
    var previousValue = false;

    socket.on('connect', function(data) {
        socket.emit("update")
        setInterval(() => {
            socket.emit("update")
        }, 1000)
    });

    socket.on("data", (data) => {
        console.log(data)
        updateDoorCard("fd-status", data.front_door)
        updateDoorCard("bd-status", data.bike_door)
        updateDoorCard("ld-status", data.lab_door)
        updateShutters(data.shutters)
    })

    function updateDoorCard(id, status) {
        const card = document.getElementById(id)
        const indicator = card.querySelector(".btn")

        if (status) {
            indicator.classList.add("btn-success")
            indicator.classList.remove("btn-danger")
            indicator.textContent = "Closed"
        } else {
            indicator.classList.remove("btn-success")
            indicator.classList.add("btn-danger")
            indicator.textContent = "Open"
        }
    }

    function updateShutters(status) {
        if (updatingShutters && previousValue == status) return
        updatingShutters = false
        previousValue = status

        const card = document.getElementById("shutters-status")
        const title = card.querySelector(".card-title")
        const indicator = card.querySelector(".btn")

        if (status) {
            title.textContent = "Shutters (Open)" 
            indicator.textContent = "Close"
            indicator.classList.add("btn-secondary")
            indicator.classList.remove("btn-primary")
        } else {
            title.textContent = "Shutters (Close)" 
            indicator.textContent = "Open"
            indicator.classList.remove("btn-secondary")
            indicator.classList.add("btn-primary")
        }
    }

    function toggleShutters() {
        updatingShutters = true
        socket.emit("toggleShutters")
        const indicator = document.querySelector("#shutters-status .btn")
        indicator.textContent = "..."
    }
</script>

{% endblock %}